name: Sync Fork with Upstream Omarchy

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/basecamp/omarchy.git || true
          git fetch upstream

      - name: Check for upstream updates
        id: check_updates
        run: |
          # Get commit counts
          BEHIND=$(git rev-list --count HEAD..upstream/master)
          echo "commits_behind=$BEHIND" >> $GITHUB_OUTPUT

          if [ "$BEHIND" -eq 0 ]; then
            echo "status=up-to-date" >> $GITHUB_OUTPUT
            echo "âœ“ Fork is up to date with upstream"
          else
            echo "status=updates-available" >> $GITHUB_OUTPUT
            echo "âš  Fork is $BEHIND commits behind upstream"
          fi

      - name: Attempt merge
        id: merge
        if: steps.check_updates.outputs.status == 'updates-available'
        continue-on-error: true
        run: |
          # Attempt to merge upstream
          if git merge upstream/master --no-edit; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ“ Successfully merged upstream changes"
          else
            echo "result=conflict" >> $GITHUB_OUTPUT
            echo "âœ— Merge conflicts detected"

            # Get list of conflicted files
            CONFLICTS=$(git diff --name-only --diff-filter=U)
            echo "conflicts<<EOF" >> $GITHUB_OUTPUT
            echo "$CONFLICTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # Abort the merge
            git merge --abort
            exit 1
          fi

      - name: Push successful merge
        if: steps.merge.outputs.result == 'success'
        run: |
          git push origin master
          echo "âœ“ Pushed merge to origin/master"

      - name: Create issue for merge conflicts
        if: steps.merge.outputs.result == 'conflict'
        uses: actions/github-script@v7
        env:
          CONFLICTS: ${{ steps.merge.outputs.conflicts }}
          COMMITS_BEHIND: ${{ steps.check_updates.outputs.commits_behind }}
        with:
          script: |
            const conflicts = process.env.CONFLICTS;
            const commitsBehind = process.env.COMMITS_BEHIND;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync-conflict'
            });

            if (issues.data.length > 0) {
              console.log('Conflict issue already exists, updating...');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: '## ðŸ”„ New Upstream Sync Attempt Failed\n\n**Date**: ' + new Date().toISOString() + '\n**Commits Behind**: ' + commitsBehind + '\n\n**Conflicted Files**:\n```\n' + conflicts + '\n```'
              });
            } else {
              console.log('Creating new conflict issue...');
              const conflictList = conflicts.split('\n').filter(f => f).map(f => '- `' + f + '`').join('\n');
              const issueBody = `## Merge Conflicts Detected

The automated sync from upstream [basecamp/omarchy](https://github.com/basecamp/omarchy) encountered merge conflicts.

**Commits Behind**: ${commitsBehind}

**Conflicted Files**:
\`\`\`
${conflicts}
\`\`\`

## How to Resolve

### Option 1: Use Claude Code (Recommended)

1. Open this repo in Claude Code
2. Run:
   \`\`\`bash
   cd ~/dev/omarchy-base
   git fetch upstream
   git merge upstream/master
   \`\`\`
3. Ask Claude to resolve the conflicts while preserving your customizations
4. After Claude resolves, commit and push:
   \`\`\`bash
   git add .
   git commit -m "Resolve upstream merge conflicts"
   git push origin master
   \`\`\`

### Option 2: Manual Resolution

\`\`\`bash
cd ~/dev/omarchy-base
git fetch upstream
git merge upstream/master
# Manually resolve conflicts in the files listed above
git add .
git commit -m "Resolve upstream merge conflicts"
git push origin master
\`\`\`

## Files in Conflict

The following files have conflicting changes between your fork and upstream:

${conflictList}

---

**@claude** - Please help resolve these merge conflicts while preserving the custom configurations in this fork.

Close this issue once conflicts are resolved and changes are pushed.`;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Upstream Sync Conflicts - @claude Help Needed',
                labels: ['upstream-sync-conflict', 'help-wanted'],
                body: issueBody
              });
            }

      - name: Summary
        if: always()
        env:
          CHECK_STATUS: ${{ steps.check_updates.outputs.status }}
          MERGE_RESULT: ${{ steps.merge.outputs.result }}
          COMMITS_BEHIND: ${{ steps.check_updates.outputs.commits_behind }}
          CONFLICTS: ${{ steps.merge.outputs.conflicts }}
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CHECK_STATUS" == "up-to-date" ]; then
            echo "âœ“ Fork is up to date with upstream" >> $GITHUB_STEP_SUMMARY
          elif [ "$MERGE_RESULT" == "success" ]; then
            echo "âœ“ Successfully merged $COMMITS_BEHIND commits from upstream" >> $GITHUB_STEP_SUMMARY
          elif [ "$MERGE_RESULT" == "conflict" ]; then
            echo "âœ— Merge conflicts detected in $COMMITS_BEHIND commits" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Conflicted Files**:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$CONFLICTS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“‹ Issue created for manual resolution" >> $GITHUB_STEP_SUMMARY
          fi
